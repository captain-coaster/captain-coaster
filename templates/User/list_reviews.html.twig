{% extends "layouts/base.html.twig" %}

{% import "macros/_macros_helpers.html.twig" as helper %}
{% import "macros/ui.html.twig" as ui %}

{% set title = 'users.reviews.title'|trans({'%name%': user.displayName}) %}
{% block title %}{{ title }}{% endblock %}

{% block body %}
  <div class="max-w-2xl mx-auto">
    {# Compact User Header #}
    <div class="flex items-center gap-3 mb-6">
      <a href="{{ path('user_show', {'slug': user.slug}) }}" class="shrink-0">
        {{ helper.profilePicture(user, 'w-10 h-10 rounded-full object-cover') }}
      </a>
      <div class="min-w-0 flex-1">
        <h1 class="text-lg font-bold text-neutral-900 dark:text-white truncate">
          {{ user.displayName }}
        </h1>
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          {{ reviews.getTotalItemCount() }} {{ 'review.title'|trans|lower }}
        </p>
      </div>
      <a href="{{ path('user_show', {'slug': user.slug}) }}" 
         class="p-2 rounded-lg text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors">
        {{ ux_icon('tabler:arrow-left', {'class': 'w-5 h-5', 'aria-hidden': 'true'}) }}
      </a>
    </div>

    {% if reviews.getTotalItemCount() > 0 %}
      <div class="space-y-4">
        {% for review in reviews %}
          <article class="bg-white dark:bg-neutral-900 rounded-xl border border-neutral-100 dark:border-neutral-800 overflow-hidden">
            {# Coaster Header - Clickable #}
            <a href="{{ path('show_coaster', {'id': review.coaster.id, 'slug': review.coaster.slug}) }}" 
               class="flex items-center gap-3 p-3 border-b border-neutral-100 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition-colors">
              {% if review.coaster.mainImage is not null %}
                <img src="{{ pictures_cdn }}/280x210/{{ review.coaster.mainImage.filename }}"
                     class="w-12 h-12 rounded-lg object-cover shrink-0"
                     alt="{{ review.coaster.name }}"
                     loading="lazy">
              {% endif %}
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-sm text-neutral-900 dark:text-white truncate">
                  {{ review.coaster.name }}
                </div>
                <div class="text-xs text-neutral-500 dark:text-neutral-400 truncate">
                  {{ review.coaster.park.name }}
                </div>
              </div>
              <div class="shrink-0">
                {{ ui.starRating(review.value, 'sm') }}
              </div>
            </a>

            {# Review Content #}
            <div class="p-4">
              {# Pros/Cons tags #}
              {% if review.pros|length > 0 or review.cons|length > 0 %}
                <div class="flex flex-wrap gap-1.5 mb-3">
                  {% for pros in review.pros %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400">
                      {{ ux_icon('tabler:plus', {'class': 'w-3 h-3', 'aria-hidden': 'true'}) }}
                      {{ pros.name|trans([], 'database') }}
                    </span>
                  {% endfor %}
                  {% for cons in review.cons %}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-400">
                      {{ ux_icon('tabler:minus', {'class': 'w-3 h-3', 'aria-hidden': 'true'}) }}
                      {{ cons.name|trans([], 'database') }}
                    </span>
                  {% endfor %}
                </div>
              {% endif %}

              {# Review text #}
              {% if review.review %}
                <p class="text-neutral-700 dark:text-neutral-300 text-sm leading-relaxed">
                  {{ review.review }}
                </p>
              {% endif %}

              {# Footer #}
              <div class="flex items-center justify-between mt-4 pt-3 border-t border-neutral-100 dark:border-neutral-800">
                <span class="text-xs text-neutral-400">
                  {{ review.updatedAt|ago }}
                </span>
                <div class="flex items-center gap-3">
                  {% if review.upvotes|length > 0 %}
                    <span class="inline-flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                      {{ ux_icon('tabler:thumb-up-filled', {'class': 'w-3.5 h-3.5', 'aria-hidden': 'true'}) }}
                      {{ review.upvotes|length }}
                    </span>
                  {% endif %}
                  {% if is_granted('update', review) %}
                    <a href="{{ path('review_form', {'id': review.coaster.id}) }}" 
                       class="inline-flex items-center gap-1 text-xs text-cc-blue-600 dark:text-cc-blue-400 hover:text-cc-blue-700 dark:hover:text-cc-blue-300 transition-colors"
                       title="{{ 'review.update'|trans }}">
                      {{ ux_icon('tabler:edit', {'class': 'w-3.5 h-3.5', 'aria-hidden': 'true'}) }}
                      {{ 'review.Update'|trans }}
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>

      <div class="mt-6">
        {{ knp_pagination_render(reviews) }}
      </div>
    {% else %}
      {% include 'components/empty_state.html.twig' with {
        icon: 'tabler:message-circle',
        title: 'review.title'|trans,
        description: 'review.share'|trans
      } %}
    {% endif %}
  </div>
{% endblock %}
