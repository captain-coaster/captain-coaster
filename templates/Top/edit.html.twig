{% extends "base.html.twig" %}

{% import 'helper.html.twig' as helper %}

{% set title = topName %}
{% block title %}{{ title }}{% endblock %}

{% set showSearchBar = 0 %}

{% form_theme form _self %}

{% block _top_topCoasters_entry_widget %}
  <li class="coaster-entry" 
      data-coaster-id="{% if form.vars.data is not null %}{{ form.vars.data.coaster.id }}{% endif %}"
      data-position="{% if form.vars.data is not null %}{{ form.vars.data.position }}{% else %}1{% endif %}"
      data-top-list-target="item">
    <div style="display: none;">{{ form_widget(form) }}</div>

    {# Drag Area with Position Number #}
    <div class="drag-area">
      <div class="position-number">{% if form.vars.data is not null %}{{ form.vars.data.position }}{% else %}1{% endif %}</div>
      <div class="drag-indicator">
        {{ ux_icon('heroicons:bars-3', {'class': 'w-4 h-4'}) }}
      </div>
    </div>

    {# Coaster Information #}
    <div class="coaster-content">
      <div class="coaster-main">
        <span class="coaster-name">{{ form.vars.data.coaster.name|default('__coastername__') }}</span>
        {% if form.vars.data is not null %}
          <span class="coaster-separator">•</span>
          <span class="coaster-park">{{ form.vars.data.coaster.park.name|default('') }}</span>
        {% endif %}
      </div>
      {% if form.vars.data is not null %}
        {% set userRating = app.user.rating(form.vars.data.coaster).value|default(null) %}
        {% if userRating %}
          <span class="coaster-rating">{{ helper.starRating(userRating) }}</span>
        {% endif %}
      {% endif %}
    </div>

    {# Single Actions Menu #}
    <div class="coaster-menu">
      <div class="dropdown">
        <button type="button" class="menu-btn" data-toggle="dropdown" aria-expanded="false" aria-label="{{ 'actions.move_to_top'|trans({}, 'top') }}">
          {{ ux_icon('heroicons:cog-6-tooth', {'class': 'w-5 h-5'}) }}
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
          <li>
            <a href="#" data-action="click->top-list#moveToTop">
              {{ ux_icon('heroicons:arrow-up', {'class': 'w-4 h-4'}) }}
              {{ 'actions.move_to_top'|trans({}, 'top') }}
            </a>
          </li>
          <li>
            <a href="#" data-action="click->top-list#moveToBottom">
              {{ ux_icon('heroicons:arrow-down', {'class': 'w-4 h-4'}) }}
              {{ 'actions.move_to_bottom'|trans({}, 'top') }}
            </a>
          </li>
          <li>
            <a href="#" data-action="click->top-list#moveToPosition">
              {{ ux_icon('heroicons:arrows-up-down', {'class': 'w-4 h-4'}) }}
              {{ 'actions.move_to_position'|trans({}, 'top') }}
            </a>
          </li>
          <li class="dropdown-divider"></li>
          <li>
            <a href="#" class="text-danger" data-action="click->top-list#removeCoaster">
              {{ ux_icon('heroicons:trash', {'class': 'w-4 h-4'}) }}
              {{ 'actions.remove'|trans({}, 'top') }}
            </a>
          </li>
        </ul>
      </div>
    </div>
  </li>
{% endblock %}

{% block body %}
  {# Hidden template for creating new coaster items #}
  <template id="coaster-item-template">
    <li class="coaster-entry" 
        data-coaster-id=""
        data-position="1"
        data-top-list-target="item">
      <div style="display: none;"></div>

      {# Drag Area with Position Number #}
      <div class="drag-area">
        <div class="position-number">1</div>
        <div class="drag-indicator">
          {{ ux_icon('heroicons:bars-3', {'class': 'w-4 h-4'}) }}
        </div>
      </div>

      {# Coaster Information #}
      <div class="coaster-content">
        <div class="coaster-main">
          <span class="coaster-name"></span>
          <span class="coaster-separator">•</span>
          <span class="coaster-park"></span>
        </div>
        <span class="coaster-rating"></span>
      </div>

      {# Single Actions Menu #}
      <div class="coaster-menu">
        <div class="dropdown">
          <button type="button" class="menu-btn" data-toggle="dropdown" aria-expanded="false" aria-label="{{ 'actions.move_to_top'|trans({}, 'top') }}">
            {{ ux_icon('heroicons:cog-6-tooth', {'class': 'w-5 h-5'}) }}
          </button>
          <ul class="dropdown-menu dropdown-menu-right">
            <li>
              <a href="#" data-action="click->top-list#moveToTop">
                {{ ux_icon('heroicons:arrow-up', {'class': 'w-4 h-4'}) }}
                {{ 'actions.move_to_top'|trans({}, 'top') }}
              </a>
            </li>
            <li>
              <a href="#" data-action="click->top-list#moveToBottom">
                {{ ux_icon('heroicons:arrow-down', {'class': 'w-4 h-4'}) }}
                {{ 'actions.move_to_bottom'|trans({}, 'top') }}
              </a>
            </li>
            <li>
              <a href="#" data-action="click->top-list#moveToPosition">
                {{ ux_icon('heroicons:arrows-up-down', {'class': 'w-4 h-4'}) }}
                {{ 'actions.move_to_position'|trans({}, 'top') }}
              </a>
            </li>
            <li class="dropdown-divider"></li>
            <li>
              <a href="#" class="text-danger" data-action="click->top-list#removeCoaster">
                {{ ux_icon('heroicons:trash', {'class': 'w-4 h-4'}) }}
                {{ 'actions.remove'|trans({}, 'top') }}
              </a>
            </li>
          </ul>
        </div>
      </div>
    </li>
  </template>

  {# Help Section - Collapsible #}
  <div class="panel panel-flat mb-3" data-controller="collapse">
    <div class="panel-body">
      <button type="button" 
              class="btn btn-link p-0 text-decoration-none w-100"
              data-action="click->collapse#toggle"
              aria-expanded="false"
              style="text-align: left; display: flex; align-items: center; justify-content: space-between;">
        <span style="display: flex; align-items: center; gap: 8px;">
          {{ ux_icon('heroicons:information-circle', {'class': 'w-5 h-5 text-primary'}) }}
          <strong>{{ 'help.title'|trans({}, 'top') }}</strong>
        </span>
        <span data-collapse-target="icon" style="transition: transform 0.2s ease;">
          {{ ux_icon('heroicons:chevron-down', {'class': 'w-5 h-5 text-muted'}) }}
        </span>
      </button>
      
      <div data-collapse-target="content" style="display: none; margin-top: 12px; padding-left: 32px;">
        <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #666;">
          <li style="margin-bottom: 6px;">{{ 'help.search'|trans({}, 'top') }}</li>
          <li style="margin-bottom: 6px;">{{ 'help.reorder'|trans({}, 'top') }}</li>
          <li style="margin-bottom: 6px;">{{ 'help.actions'|trans({}, 'top') }}</li>
          <li style="margin-bottom: 0;">{{ 'help.autosave'|trans({}, 'top') }}</li>
        </ul>
      </div>
    </div>
  </div>

  {# Search Component for Adding Coasters - Mobile-optimized #}
  <div class="panel panel-flat mb-3">
    <div class="panel-body p-3">
      <div data-controller="top-search" 
           data-top-search-url-value="{{ path('top_ajax_search') }}"
           data-top-search-list-controller-value="top-list"
           class="search-container">
        <input type="search" 
               data-top-search-target="input"
               data-action="input->top-search#search keydown->top-search#handleKeydown"
               class="form-control form-control-lg"
               placeholder="{{ 'search.placeholder'|trans({}, 'top') }}"
               autocomplete="off"
               aria-label="{{ 'search.placeholder'|trans({}, 'top') }}"
               style="font-size: 16px;">
        <div data-top-search-target="dropdown" class="search-dropdown">
          <div data-top-search-target="results"></div>
        </div>
      </div>
    </div>
  </div>

  {{ form_start(form) }}
  <div class="panel panel-flat mb-3">
    {% if form.vars.errors is not empty %}
      <div class="panel-heading">
        <div class="alert alert-danger alert-styled-left alert-dismissible mt-2">
          {{ form_errors(form) }}
        </div>
      </div>
    {% endif %}
    <div class="panel-body p-0 p-md-2">
      <ul id="top-coaster"
          data-prototype="{{ form_widget(form.topCoasters.vars.prototype)|e('html_attr') }}"
          class="media-list media-list-container list-unstyled mb-0"
          data-controller="top-list"
          data-top-list-target="list"
          data-top-list-auto-save-url-value="{{ path('top_auto_save', {'id': form.vars.data.id}) }}"
          data-top-list-save-delay-value="2000">
        {% for coaster in form.topCoasters %}
          {{ form_widget(coaster) }}
        {% endfor %}
      </ul>
    </div>
  </div>

  {{ form_rest(form) }}
  {{ form_end(form) }}
{% endblock %}

{% block javascripts %}
  {# Load top list specific JavaScript bundle #}
  {{ encore_entry_script_tags('top-list') }}
{% endblock %}

{% block stylesheets %}
  {# Load top list specific CSS bundle #}
  {{ encore_entry_link_tags('top-list') }}
{% endblock %}
