{% extends "layouts/base.html.twig" %}

{% import "macros/_macros_helpers.html.twig" as helper %}
{% import "macros/ui.html.twig" as ui %}

{% set title = 'profile.ratings.title'|trans %}
{% block title %}{{ title }}{% endblock %}

{% block body %}
  <div class="max-w-3xl mx-auto">
    {# Header with back navigation #}
    <div class="flex items-center gap-3 mb-6">
      <a href="{{ path('profile') }}" 
         class="p-2 rounded-lg text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors">
        {{ ux_icon('tabler:arrow-left', {'class': 'w-5 h-5', 'aria-hidden': 'true'}) }}
      </a>
      <div class="min-w-0 flex-1">
        <h1 class="text-lg font-bold text-neutral-900 dark:text-white truncate">
          {{ 'profile.ratings.title'|trans }}
        </h1>
        <p class="text-xs text-neutral-500 dark:text-neutral-400">
          {{ 'user_list.rating'|trans({'count': ratings.getTotalItemCount()}) }}
        </p>
      </div>
    </div>

    {% if ratings.getTotalItemCount() > 0 %}
      {# Sort pills - horizontal scroll on mobile #}
      <div class="flex items-center gap-2 mb-4 overflow-x-auto pb-2 -mx-4 px-4 scrollbar-hide">
        <span class="text-xs text-neutral-500 dark:text-neutral-400 shrink-0">{{ 'filters.title'|trans }}:</span>
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 whitespace-nowrap">
          {{ knp_pagination_sortable(ratings, 'users.ratings.coaster'|trans, 'c.name') }}
        </span>
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 whitespace-nowrap">
          {{ knp_pagination_sortable(ratings, 'users.ratings.rating'|trans, 'r.value') }}
        </span>
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 whitespace-nowrap">
          {{ knp_pagination_sortable(ratings, 'users.ratings.ridden_at'|trans, 'r.riddenAt') }}
        </span>
        <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 whitespace-nowrap">
          {{ knp_pagination_sortable(ratings, 'users.ratings.opening_date'|trans, 'c.openingDate') }}
        </span>
      </div>

      {# Ratings List #}
      <div class="space-y-2">
        {% for rating in ratings %}
          <div class="flex items-center gap-3 p-3 bg-white dark:bg-neutral-900 rounded-xl border border-neutral-100 dark:border-neutral-800" id="tr-coaster-{{ rating.coaster.id }}">
            {# Coaster Image #}
            {% if rating.coaster.mainImage is not null %}
              <a href="{{ path('show_coaster', {'id': rating.coaster.id, 'slug': rating.coaster.slug}) }}" class="shrink-0">
                <img src="{{ pictures_cdn }}/280x210/{{ rating.coaster.mainImage.filename }}"
                     class="w-14 h-10 rounded-lg object-cover"
                     alt="{{ rating.coaster.name }}"
                     loading="lazy">
              </a>
            {% endif %}

            {# Coaster Info #}
            <div class="flex-1 min-w-0">
              <a href="{{ path('show_coaster', {'id': rating.coaster.id, 'slug': rating.coaster.slug}) }}" 
                 class="font-medium text-sm text-neutral-900 dark:text-white truncate block hover:text-cc-blue-600 dark:hover:text-cc-blue-400 transition-colors">
                {{ rating.coaster.name }}
              </a>
              <div class="text-xs text-neutral-500 dark:text-neutral-400 truncate flex items-center gap-1">
                <span class="status-mark bg-{{ rating.coaster.status.type }}"></span>
                {{ rating.coaster.park.name }}
                {% if rating.coaster.manufacturer %}
                  <span class="text-neutral-300 dark:text-neutral-600 mx-1">â€¢</span>
                  {{ rating.coaster.manufacturer.name }}
                {% endif %}
              </div>
            </div>

            {# Rating Widget #}
            <div class="shrink-0 flex items-center gap-2">
              <div class="csrf-protection" data-controller="csrf-protection rating"
                   data-csrf-protection-token-value="{{ csrf_token('rating') }}"
                   data-rating-csrf-protection-outlet=".csrf-protection"
                   data-rating-coaster-id-value="{{ rating.coaster.id }}"
                   data-rating-current-value-value="{{ rating.value }}"
                   data-rating-rating-id-value="{{ rating.id }}"
                   data-rating-locale-value="{{ app.request.locale }}"
                   {% if not is_granted('update', rating) %}data-rating-readonly-value="true"{% endif %}>
                <div data-rating-target="rating" class="text-lg"></div>
              </div>
              
              {# Delete button #}
              {% if is_granted('delete', rating) %}
                <div data-controller="csrf-protection rating-actions"
                     data-csrf-protection-token-value="{{ csrf_token('rating') }}"
                     data-rating-actions-csrf-protection-outlet=".csrf-protection"
                     data-rating-actions-rating-id-value="{{ rating.id }}"
                     data-rating-actions-locale-value="{{ app.request.locale }}"
                     data-rating-actions-mode-value="table"
                     class="hidden sm:block">
                  <button data-action="click->rating-actions#delete" 
                          data-rating-actions-target="deleteButton" 
                          class="p-1.5 rounded-lg text-neutral-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                    {{ ux_icon('tabler:trash', {'class': 'w-4 h-4', 'aria-hidden': 'true'}) }}
                  </button>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="mt-6">
        {{ knp_pagination_render(ratings) }}
      </div>
    {% else %}
      {% include 'components/empty_state.html.twig' with {
        icon: 'tabler:star',
        title: 'profile.ratings.title'|trans,
        description: ''
      } %}
    {% endif %}
  </div>
{% endblock %}
